#!tcl

##########################################################
#             For the creation of psf files with varying pH
#                   written by John Vant
#                        ASU Biodesign
###########################################################
#                        Notes
# Make sure you are in the directory with mypdb value
# Usage:
#  in bash $ vmd -dispdev text -e build_system.pgn -args <filename>
#  in tkconsole $ source build_system.pgn 

#############################################################
# Set mypdb as the file you want to create a psf for

set mypdb [lindex $argv 0]

#############################################################
#Module load

package require psfgen

resetpsf

topology ../../namd_scripts/toppar/top_all36_prot.rtf
topology ../../namd_scripts/toppar/toppar_all36_prot_na_combined.str
topology ../../namd_scripts/toppar/top_all36_carb.rtf
topology ../../namd_scripts/toppar/toppar_water_ions.str


##############################################################
# Load pdb
mol new $mypdb

pdbalias residue HIS HSD
pdbalias residue MSE MET
pdbalias atom ILE CD1 CD
pdbalias residue HOH TIP3

##############################################################
# Get chains and write corresponding pdbs
set selchains [atomselect top "protein"]
set chains [lsort -unique [$selchains get chain]]

foreach i $chains {
    set selchain [atomselect top "chain $i and not water"]
    $selchain writepdb chain$i.pdb
}


##############################################################
# Build segments ie add H to pdb
foreach i $chains {
segment $i {pdb chain$i.pdb}
}

foreach i $chains {
    coordpdb chain$i.pdb $i
}

guesscoord
writepdb Tmp.pdb
writepsf Tmp.psf


##############################################################
#Solvate
package require solvate
solvate Tmp.psf Tmp.pdb -t 15 -o Tmp_solv


##############################################################
#Ionize
set mypdb [string trim $mypdb .pdb]

package require autoionize
autoionize -psf Tmp_solv.psf -pdb Tmp_solv.pdb -neutralize -o ./$mypdb-solv_ion
resetpsf

##############################################################
#Calculate PBC size and write file w/ values
set sel [atomselect top water]
set var_minmax [measure minmax $sel]
set var_cen [measure center $sel]

set var_size [vecsub [lindex $var_minmax 1] [lindex $var_minmax 0]]

set outfile [open "PBC_Values.str" w]
puts $outfile $var_size
puts $outfile $var_cen
close $outfile

##############################################################
# Delete temporary files
set del_files [glob chain*.pdb]
file delete Tmp_solv.psf Tmp_solv.pdb Tmp.pdb Tmp.psf Tmp_solv.log $del_files

exit
