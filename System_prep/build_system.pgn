#!tcl

##########################################################
#             For the creation of psf files with varying pH
#                   written by John Vant
#                        ASU Biodesign
###########################################################
#                        Notes
# Make sure you are in the directory with mypdb value
# Usage:
#  in bash $ vmd -dispdev text -e build_system.pgn -args <filename>
#  in tkconsole $ source build_system.pgn 

#############################################################
# Set mypdb as the file you want to create a psf for

set mypdb [lindex $argv 0]

#############################################################
#Module load

package require psfgen

resetpsf

topology ../namd_equilibration/toppar/top_all36_prot.rtf
topology ../namd_equilibration/toppar/top_all36_carb.rtf
topology ../namd_equilibration/toppar/toppar_water_ions.str


##############################################################
# Load pdb
mol new $mypdb

pdbalias residue HIS HSD
pdbalias residue MSE MET
pdbalias atom ILE CD1 CD
pdbalias residue HOH TIP3

##############################################################
# Get chains and write corresponding pdbs
set selchains [atomselect top "chain A to C"]
set chains [lsort -unique [$selchains get chain]]

foreach i $chains {
    set selchain [atomselect top "chain $i and not water"]
    $selchain writepdb chain$i.pdb
}


##############################################################
# Build segments ie add H to pdb
foreach i $chains {
segment $i {pdb chain$i.pdb}
}

foreach i $chains {
    coordpdb chain$i.pdb $i
}

guesscoord
writepdb Tmp.pdb
writepsf Tmp.psf


##############################################################
#Solvate
package require solvate
solvate Tmp.psf Tmp.pdb -t 15 -o Tmp_solv


##############################################################
#Ionize
set mypdb [string trim $mypdb .pdb]

package require autoionize
autoionize -psf Tmp_solv.psf -pdb Tmp_solv.pdb -neutralize -o ../namd_equilibration/$mypdb-solv_ion
resetpsf


##############################################################
# Delete temporary files
file delete Tmp_solv.psf Tmp_solv.pdb Tmp.pdb Tmp.psf Tmp_solv.log chain*.pdb

exit
